var VOXEL=Object.create(null);VOXEL.ThreeManager=function(){this.object3D=new THREE.Object3D,this.regionMap=Object.create(null)},VOXEL.ThreeManager.prototype.onUpdateCommand=function(a,b){var c=a.join("/");typeof this.regionMap[c]=="undefined"&&this.object3D.remove(this.regionMap[c]);if(!b.length)return;var d=Object.create(null),e=new THREE.Geometry,f=new THREE.MeshLambertMaterial({vertexColors:THREE.VertexColors}),g=e.vertices,h=e.faces;for(var i=0,j=b.length;i<j;++i){var k=b[i],l=k[0],m=k[1],n=l[0],o=l[1],p=l[2],q=n[0]+"/"+n[1]+"/"+n[2],r=o[0]+"/"+o[1]+"/"+o[2],s=p[0]+"/"+p[1]+"/"+p[2],t=typeof d[q]!="undefined"?d[q]:d[q]=g.push(new THREE.Vector3(n[0],n[1],n[2]))-1,u=typeof d[r]!="undefined"?d[r]:d[r]=g.push(new THREE.Vector3(o[0],o[1],o[2]))-1,v=typeof d[s]!="undefined"?d[s]:d[s]=g.push(new THREE.Vector3(p[0],p[1],p[2]))-1,w=new THREE.Face3(v,u,t);w.normal.set(m[0],m[1],m[2]),w.vertexColors[2]=new THREE.Color(n[3]),w.vertexColors[1]=new THREE.Color(o[3]),w.vertexColors[0]=new THREE.Color(p[3]),h.push(w)}var x=this.regionMap[c]=new THREE.Mesh(e,f);x.position.set(a[0],a[1],a[2]),this.object3D.add(this.regionMap[c])},VOXEL.BinvoxLoader=function(a,b){var c=new XMLHttpRequest;c.onload=function(){b(VOXEL.BinvoxLoader.parse(c.responseText))},c.open("GET",a,!0),c.overrideMimeType("text/plain; charset=x-user-defined"),c.send(null)},VOXEL.BinvoxLoader.format=/^#binvox 1\ndim ([0-9]*[1-9][0-9]*) (?:\1) (?:\1)\ntranslate (-?(?:[0-9]+(?:\.[0-9]*)?|[0-9]*\.[0-9]+)) (-?(?:[0-9]+(?:\.[0-9]*)?|[0-9]*\.[0-9]+)) (-?(?:[0-9]+(?:\.[0-9]*)?|[0-9]*\.[0-9]+))\nscale ([1-9][0-9]*(?:\.[0-9]*)?|0*\.[0-9]*[1-9][0-9]*)\ndata\n((?:[\S\s]{2})*)$/,VOXEL.BinvoxLoader.parse=function(a){var b=a.match(VOXEL.BinvoxLoader.format);if(!b)throw new Error("Syntax error");var c=0,d=Number(b[1]),e=[Number(b[2]),Number(b[3]),Number(b[4])],f=Number(b[5]),g=b[6],h=[];for(var i=0,j=g.length;i<j;i+=2){var k=g.charCodeAt(i)&255,l=g.charCodeAt(i+1)&255;if([0,1].indexOf(k)===-1||l<1||l>255)throw new Error("Invalid value : "+k+", "+l);k&&h.push([c,c+l]),c+=l}var m=Math.pow(d,3);if(c!==m)throw new Error("Bad voxel count (found "+c+", expected "+m+")");return{type:"binvox",size:d,translation:e,scale:f,ranges:h}},VOXEL.CreateWorker=function(){var a=null,b=function(){return window.URL?window.URL:window.webkitURL?window.webkitURL:null},c=function(){if(a===null){var c=null;window.BlobBuilder?c=window.BlobBuilder:window.WebKitBlobBuilder?c=window.WebKitBlobBuilder:window.MozBlobBuilder?c=window.MozBlobBuilder:c=!1;var d=new c;d.append(VOXEL.CreateWorker.dataScript);var e=d.getBlob();return a=b().createObjectURL(e),a}return a};return function(){return new Worker(c())}}(),VOXEL.VoxelEngine=function(a){this.modelId=0,this.worker=VOXEL.CreateWorker(),this.manager=a,this.operations=[],this.worker.onerror=this.error.bind(this),this.worker.onmessage=this.receive.bind(this),this.worker.postMessage({command:"initialization",configuration:{region:[32,128,32],block:[16,16,16]}})},VOXEL.VoxelEngine.prototype.set=function(a,b,c,d){this.operations.push({type:"set",value:d,x:a,y:b,z:c})},VOXEL.VoxelEngine.prototype.prepare=function(a){var b=this.modelId++;return this.operations.push({type:"prepare",id:b,model:a}),b},VOXEL.VoxelEngine.prototype.apply=function(a){var b=Array.prototype.slice.call(arguments,0);b.shift(),this.operations.push({type:"apply",id:a,arguments:b})},VOXEL.VoxelEngine.prototype.release=function(a){this.operations.push({type:"release",id:a})},VOXEL.VoxelEngine.prototype.rollback=function(){this.operations=[]},VOXEL.VoxelEngine.prototype.commit=function(){this.worker.postMessage({command:"commit",operations:this.operations})},VOXEL.VoxelEngine.prototype.receive=function(a){var b=a.data;switch(b.command){case"update":this.manager.onUpdateCommand(b.position,b.polygons)}},VOXEL.VoxelEngine.prototype.error=function(a){console.log(a)},VOXEL.CreateWorker.dataScript='var VOXEL=Object.create(null);VOXEL.Tables={vertexOffsets:[[0,0,0],[1,0,0],[1,1,0],[0,1,0],[0,0,1],[1,0,1],[1,1,1],[0,1,1]],edgeConnections:[[0,1],[1,2],[2,3],[3,0],[4,5],[5,6],[6,7],[7,4],[0,4],[1,5],[2,6],[3,7]],edgeDirections:[[1,0,0],[0,1,0],[-1,0,0],[0,-1,0],[1,0,0],[0,1,0],[-1,0,0],[0,-1,0],[0,0,1],[0,0,1],[0,0,1],[0,0,1]],edgeFlagMap:[0,265,515,778,1030,1295,1541,1804,2060,2309,2575,2822,3082,3331,3593,3840,400,153,915,666,1430,1183,1941,1692,2460,2197,2975,2710,3482,3219,3993,3728,560,825,51,314,1590,1855,1077,1340,2620,2869,2111,2358,3642,3891,3129,3376,928,681,419,170,1958,1711,1445,1196,2988,2725,2479,2214,4010,3747,3497,3232,1120,1385,1635,1898,102,367,613,876,3180,3429,3695,3942,2154,2403,2665,2912,1520,1273,2035,1786,502,255,1013,764,3580,3317,4095,3830,2554,2291,3065,2800,1616,1881,1107,1370,598,863,85,348,3676,3925,3167,3414,2650,2899,2137,2384,1984,1737,1475,1226,966,719,453,204,4044,3781,3535,3270,3018,2755,2505,2240,2240,2505,2755,3018,3270,3535,3781,4044,204,453,719,966,1226,1475,1737,1984,2384,2137,2899,2650,3414,3167,3925,3676,348,85,863,598,1370,1107,1881,1616,2800,3065,2291,2554,3830,4095,3317,3580,764,1013,255,502,1786,2035,1273,1520,2912,2665,2403,2154,3942,3695,3429,3180,876,613,367,102,1898,1635,1385,1120,3232,3497,3747,4010,2214,2479,2725,2988,1196,1445,1711,1958,170,419,681,928,3376,3129,3891,3642,2358,2111,2869,2620,1340,1077,1855,1590,314,51,825,560,3728,3993,3219,3482,2710,2975,2197,2460,1692,1941,1183,1430,666,915,153,400,3840,3593,3331,3082,2822,2575,2309,2060,1804,1541,1295,1030,778,515,265,0],triangleConnections:[[],[0,8,3],[0,1,9],[1,8,3,9,8,1],[1,2,10],[0,8,3,1,2,10],[9,2,10,0,2,9],[2,8,3,2,10,8,10,9,8],[3,11,2],[0,11,2,8,11,0],[1,9,0,2,3,11],[1,11,2,1,9,11,9,8,11],[3,10,1,11,10,3],[0,10,1,0,8,10,8,11,10],[3,9,0,3,11,9,11,10,9],[9,8,10,10,8,11],[4,7,8],[4,3,0,7,3,4],[0,1,9,8,4,7],[4,1,9,4,7,1,7,3,1],[1,2,10,8,4,7],[3,4,7,3,0,4,1,2,10],[9,2,10,9,0,2,8,4,7],[2,10,9,2,9,7,2,7,3,7,9,4],[8,4,7,3,11,2],[11,4,7,11,2,4,2,0,4],[9,0,1,8,4,7,2,3,11],[4,7,11,9,4,11,9,11,2,9,2,1],[3,10,1,3,11,10,7,8,4],[1,11,10,1,4,11,1,0,4,7,11,4],[4,7,8,9,0,11,9,11,10,11,0,3],[4,7,11,4,11,9,9,11,10],[9,5,4],[9,5,4,0,8,3],[0,5,4,1,5,0],[8,5,4,8,3,5,3,1,5],[1,2,10,9,5,4],[3,0,8,1,2,10,4,9,5],[5,2,10,5,4,2,4,0,2],[2,10,5,3,2,5,3,5,4,3,4,8],[9,5,4,2,3,11],[0,11,2,0,8,11,4,9,5],[0,5,4,0,1,5,2,3,11],[2,1,5,2,5,8,2,8,11,4,8,5],[10,3,11,10,1,3,9,5,4],[4,9,5,0,8,1,8,10,1,8,11,10],[5,4,0,5,0,11,5,11,10,11,0,3],[5,4,8,5,8,10,10,8,11],[9,7,8,5,7,9],[9,3,0,9,5,3,5,7,3],[0,7,8,0,1,7,1,5,7],[1,5,3,3,5,7],[9,7,8,9,5,7,10,1,2],[10,1,2,9,5,0,5,3,0,5,7,3],[8,0,2,8,2,5,8,5,7,10,5,2],[2,10,5,2,5,3,3,5,7],[7,9,5,7,8,9,3,11,2],[9,5,7,9,7,2,9,2,0,2,7,11],[2,3,11,0,1,8,1,7,8,1,5,7],[11,2,1,11,1,7,7,1,5],[9,5,8,8,5,7,10,1,3,10,3,11],[5,7,0,5,0,9,7,11,0,1,0,10,11,10,0],[11,10,0,11,0,3,10,5,0,8,0,7,5,7,0],[11,10,5,7,11,5],[10,6,5],[0,8,3,5,10,6],[9,0,1,5,10,6],[1,8,3,1,9,8,5,10,6],[1,6,5,2,6,1],[1,6,5,1,2,6,3,0,8],[9,6,5,9,0,6,0,2,6],[5,9,8,5,8,2,5,2,6,3,2,8],[2,3,11,10,6,5],[11,0,8,11,2,0,10,6,5],[0,1,9,2,3,11,5,10,6],[5,10,6,1,9,2,9,11,2,9,8,11],[6,3,11,6,5,3,5,1,3],[0,8,11,0,11,5,0,5,1,5,11,6],[3,11,6,0,3,6,0,6,5,0,5,9],[6,5,9,6,9,11,11,9,8],[5,10,6,4,7,8],[4,3,0,4,7,3,6,5,10],[1,9,0,5,10,6,8,4,7],[10,6,5,1,9,7,1,7,3,7,9,4],[6,1,2,6,5,1,4,7,8],[1,2,5,5,2,6,3,0,4,3,4,7],[8,4,7,9,0,5,0,6,5,0,2,6],[7,3,9,7,9,4,3,2,9,5,9,6,2,6,9],[3,11,2,7,8,4,10,6,5],[5,10,6,4,7,2,4,2,0,2,7,11],[0,1,9,4,7,8,2,3,11,5,10,6],[9,2,1,9,11,2,9,4,11,7,11,4,5,10,6],[8,4,7,3,11,5,3,5,1,5,11,6],[5,1,11,5,11,6,1,0,11,7,11,4,0,4,11],[0,5,9,0,6,5,0,3,6,11,6,3,8,4,7],[6,5,9,6,9,11,4,7,9,7,11,9],[10,4,9,6,4,10],[4,10,6,4,9,10,0,8,3],[10,0,1,10,6,0,6,4,0],[8,3,1,8,1,6,8,6,4,6,1,10],[1,4,9,1,2,4,2,6,4],[3,0,8,1,2,9,2,4,9,2,6,4],[0,2,4,4,2,6],[8,3,2,8,2,4,4,2,6],[10,4,9,10,6,4,11,2,3],[0,8,2,2,8,11,4,9,10,4,10,6],[3,11,2,0,1,6,0,6,4,6,1,10],[6,4,1,6,1,10,4,8,1,2,1,11,8,11,1],[9,6,4,9,3,6,9,1,3,11,6,3],[8,11,1,8,1,0,11,6,1,9,1,4,6,4,1],[3,11,6,3,6,0,0,6,4],[6,4,8,11,6,8],[7,10,6,7,8,10,8,9,10],[0,7,3,0,10,7,0,9,10,6,7,10],[10,6,7,1,10,7,1,7,8,1,8,0],[10,6,7,10,7,1,1,7,3],[1,2,6,1,6,8,1,8,9,8,6,7],[2,6,9,2,9,1,6,7,9,0,9,3,7,3,9],[7,8,0,7,0,6,6,0,2],[7,3,2,6,7,2],[2,3,11,10,6,8,10,8,9,8,6,7],[2,0,7,2,7,11,0,9,7,6,7,10,9,10,7],[1,8,0,1,7,8,1,10,7,6,7,10,2,3,11],[11,2,1,11,1,7,10,6,1,6,7,1],[8,9,6,8,6,7,9,1,6,11,6,3,1,3,6],[0,9,1,11,6,7],[7,8,0,7,0,6,3,11,0,11,6,0],[7,11,6],[7,6,11],[3,0,8,11,7,6],[0,1,9,11,7,6],[8,1,9,8,3,1,11,7,6],[10,1,2,6,11,7],[1,2,10,3,0,8,6,11,7],[2,9,0,2,10,9,6,11,7],[6,11,7,2,10,3,10,8,3,10,9,8],[7,2,3,6,2,7],[7,0,8,7,6,0,6,2,0],[2,7,6,2,3,7,0,1,9],[1,6,2,1,8,6,1,9,8,8,7,6],[10,7,6,10,1,7,1,3,7],[10,7,6,1,7,10,1,8,7,1,0,8],[0,3,7,0,7,10,0,10,9,6,10,7],[7,6,10,7,10,8,8,10,9],[6,8,4,11,8,6],[3,6,11,3,0,6,0,4,6],[8,6,11,8,4,6,9,0,1],[9,4,6,9,6,3,9,3,1,11,3,6],[6,8,4,6,11,8,2,10,1],[1,2,10,3,0,11,0,6,11,0,4,6],[4,11,8,4,6,11,0,2,9,2,10,9],[10,9,3,10,3,2,9,4,3,11,3,6,4,6,3],[8,2,3,8,4,2,4,6,2],[0,4,2,4,6,2],[1,9,0,2,3,4,2,4,6,4,3,8],[1,9,4,1,4,2,2,4,6],[8,1,3,8,6,1,8,4,6,6,10,1],[10,1,0,10,0,6,6,0,4],[4,6,3,4,3,8,6,10,3,0,3,9,10,9,3],[10,9,4,6,10,4],[4,9,5,7,6,11],[0,8,3,4,9,5,11,7,6],[5,0,1,5,4,0,7,6,11],[11,7,6,8,3,4,3,5,4,3,1,5],[9,5,4,10,1,2,7,6,11],[6,11,7,1,2,10,0,8,3,4,9,5],[7,6,11,5,4,10,4,2,10,4,0,2],[3,4,8,3,5,4,3,2,5,10,5,2,11,7,6],[7,2,3,7,6,2,5,4,9],[9,5,4,0,8,6,0,6,2,6,8,7],[3,6,2,3,7,6,1,5,0,5,4,0],[6,2,8,6,8,7,2,1,8,4,8,5,1,5,8],[9,5,4,10,1,6,1,7,6,1,3,7],[1,6,10,1,7,6,1,0,7,8,7,0,9,5,4],[4,0,10,4,10,5,0,3,10,6,10,7,3,7,10],[7,6,10,7,10,8,5,4,10,4,8,10],[6,9,5,6,11,9,11,8,9],[3,6,11,0,6,3,0,5,6,0,9,5],[0,11,8,0,5,11,0,1,5,5,6,11],[6,11,3,6,3,5,5,3,1],[1,2,10,9,5,11,9,11,8,11,5,6],[0,11,3,0,6,11,0,9,6,5,6,9,1,2,10],[11,8,5,11,5,6,8,0,5,10,5,2,0,2,5],[6,11,3,6,3,5,2,10,3,10,5,3],[5,8,9,5,2,8,5,6,2,3,8,2],[9,5,6,9,6,0,0,6,2],[1,5,8,1,8,0,5,6,8,3,8,2,6,2,8],[1,5,6,2,1,6],[1,3,6,1,6,10,3,8,6,5,6,9,8,9,6],[10,1,0,10,0,6,9,5,0,5,6,0],[0,3,8,5,6,10],[10,5,6],[11,5,10,7,5,11],[11,5,10,11,7,5,8,3,0],[5,11,7,5,10,11,1,9,0],[10,7,5,10,11,7,9,8,1,8,3,1],[11,1,2,11,7,1,7,5,1],[0,8,3,1,2,7,1,7,5,7,2,11],[9,7,5,9,2,7,9,0,2,2,11,7],[7,5,2,7,2,11,5,9,2,3,2,8,9,8,2],[2,5,10,2,3,5,3,7,5],[8,2,0,8,5,2,8,7,5,10,2,5],[9,0,1,5,10,3,5,3,7,3,10,2],[9,8,2,9,2,1,8,7,2,10,2,5,7,5,2],[1,3,5,3,7,5],[0,8,7,0,7,1,1,7,5],[9,0,3,9,3,5,5,3,7],[9,8,7,5,9,7],[5,8,4,5,10,8,10,11,8],[5,0,4,5,11,0,5,10,11,11,3,0],[0,1,9,8,4,10,8,10,11,10,4,5],[10,11,4,10,4,5,11,3,4,9,4,1,3,1,4],[2,5,1,2,8,5,2,11,8,4,5,8],[0,4,11,0,11,3,4,5,11,2,11,1,5,1,11],[0,2,5,0,5,9,2,11,5,4,5,8,11,8,5],[9,4,5,2,11,3],[2,5,10,3,5,2,3,4,5,3,8,4],[5,10,2,5,2,4,4,2,0],[3,10,2,3,5,10,3,8,5,4,5,8,0,1,9],[5,10,2,5,2,4,1,9,2,9,4,2],[8,4,5,8,5,3,3,5,1],[0,4,5,1,0,5],[8,4,5,8,5,3,9,0,5,0,3,5],[9,4,5],[4,11,7,4,9,11,9,10,11],[0,8,3,4,9,7,9,11,7,9,10,11],[1,10,11,1,11,4,1,4,0,7,4,11],[3,1,4,3,4,8,1,10,4,7,4,11,10,11,4],[4,11,7,9,11,4,9,2,11,9,1,2],[9,7,4,9,11,7,9,1,11,2,11,1,0,8,3],[11,7,4,11,4,2,2,4,0],[11,7,4,11,4,2,8,3,4,3,2,4],[2,9,10,2,7,9,2,3,7,7,4,9],[9,10,7,9,7,4,10,2,7,8,7,0,2,0,7],[3,7,10,3,10,2,7,4,10,1,10,0,4,0,10],[1,10,2,8,7,4],[4,9,1,4,1,7,7,1,3],[4,9,1,4,1,7,0,8,1,8,7,1],[4,0,3,7,4,3],[4,8,7],[9,10,8,10,11,8],[3,0,9,3,9,11,11,9,10],[0,1,10,0,10,8,8,10,11],[3,1,10,11,3,10],[1,2,11,1,11,9,9,11,8],[3,0,9,3,9,11,1,2,9,2,11,9],[0,2,11,8,0,11],[3,2,11],[2,3,8,2,8,10,10,8,9],[9,10,2,0,9,2],[2,3,8,2,8,10,0,1,8,1,10,8],[1,10,2],[1,3,8,9,1,8],[0,9,1],[0,3,8],[]]},VOXEL.BinvoxBrush=function(a,b,c,d,e,f){var g=a.size,h=a.translation,i=a.scale,j=a.ranges,k=h[0]/i,l=h[1]/i,m=h[2]/i;for(var n=0,o=j.length;n<o;++n){var p=j[n];for(var q=p[0],r=p[1];q<r;++q){var s=Math.floor(q/g/g%g),t=Math.floor(q%g),u=Math.floor(q/g%g),v=Math.floor(c+k+s),w=Math.floor(d+l+t),x=Math.floor(e+m+u);b.set(v,w,x,f)}}},VOXEL.Block=function(a){this.needsMerge=!1,this.referenceCount=0,this.buffer=a?VOXEL.Block.cloneBuffer(a):VOXEL.Block.createBuffer(),this.dataView=new Uint32Array(this.buffer)},VOXEL.Block.getIndexFromCoordinates=function(a,b,c){var d=VOXEL.Block.width,e=VOXEL.Block.height,f=VOXEL.Block.depth;return Math.abs(c)*d*e+Math.abs(b)*d+Math.abs(a)},VOXEL.Block.createBuffer=function(){var a=VOXEL.Block.width,b=VOXEL.Block.height,c=VOXEL.Block.depth,d=new ArrayBuffer(a*b*c*4),e=new Uint8Array(d);for(var f=0,g=d.byteLength;f<g;++f)e[f]=255;return d},VOXEL.Block.cloneBuffer=function(a){return a.slice(0)},VOXEL.Block.prototype.set=function(a,b,c,d){this.dataView[VOXEL.Block.getIndexFromCoordinates(a,b,c)]=d},VOXEL.Block.prototype.get=function(a,b,c){return this.dataView[VOXEL.Block.getIndexFromCoordinates(a,b,c)]},VOXEL.Block.prototype.clone=function(){return new VOXEL.Block(this.buffer)},VOXEL.BlockMap=function(){this.indexedBlocks=Object.create(null),this.blocksNeedingMerge=[],this.resetCache()},VOXEL.BlockMap.prototype.resetCache=function(){this.cache={}},VOXEL.BlockMap.prototype.set=function(a,b,c,d){a=Math.floor(a),b=Math.floor(b),c=Math.floor(c);var e=VOXEL.Block.width,f=VOXEL.Block.height,g=VOXEL.Block.depth,h=Math.floor(a/e),i=Math.floor(b/f),j=Math.floor(c/g),k=h+"/"+i+"/"+j,l=this.indexedBlocks[k];l||(l=this.indexedBlocks[k]=new VOXEL.Block),l.needsMerge||(this.blocksNeedingMerge.push(l),l.needsMerge=!0),l.set(a%e,b%f,c%g,d)},VOXEL.BlockMap.prototype.get=function(a,b,c){a=Math.floor(a),b=Math.floor(b),c=Math.floor(c);var d=a+"/"+b+"/"+c;if(d in this.cache)return this.cache[d];var e=VOXEL.Block.width,f=VOXEL.Block.height,g=VOXEL.Block.depth,h=Math.floor(a/e),i=Math.floor(b/f),j=Math.floor(c/g),k=h+"/"+i+"/"+j,l=this.indexedBlocks[k];return l?l.get(a%e,b%f,c%g):4294967295},VOXEL.BlockMap.prototype.mergeAll=function(){},VOXEL.Region=function(a,b,c,d){this.needsUpdate=!1,this.regionMap=a,this.x=b,this.y=c,this.z=d},VOXEL.Region.prototype.update=function(){var a=[],b=VOXEL.Region.width,c=VOXEL.Region.height,d=VOXEL.Region.depth,e=VOXEL.Tables.vertexOffsets,f=VOXEL.Tables.edgeConnections,g=VOXEL.Tables.edgeDirections,h=VOXEL.Tables.edgeFlagMap,i=VOXEL.Tables.triangleConnections,j=this.x*b,k=this.y*c,l=this.z*d;this.regionMap.blockMap.resetCache();var m=this.regionMap.blockMap.get.bind(this.regionMap.blockMap);for(var n=0;n<b;++n)for(var o=0;o<c;++o)for(var p=0;p<d;++p){var q=j+n,r=k+o,s=l+p,t=[m(q+0,r+0,s+0),m(q+1,r+0,s+0),m(q+1,r+1,s+0),m(q+0,r+1,s+0),m(q+0,r+0,s+1),m(q+1,r+0,s+1),m(q+1,r+1,s+1),m(q+0,r+1,s+1)],u=(t[0]!==4294967295?1:0)|(t[1]!==4294967295?2:0)|(t[2]!==4294967295?4:0)|(t[3]!==4294967295?8:0)|(t[4]!==4294967295?16:0)|(t[5]!==4294967295?32:0)|(t[6]!==4294967295?64:0)|(t[7]!==4294967295?128:0),v=h[u];if(v===0)continue;var w={};for(var x=0;x<12;++x)if(v&1<<x){var y=f[x],z=g[x],A=e[y[0]];w[x]=[n+A[0]+z[0]/2,o+A[1]+z[1]/2,p+A[2]+z[2]/2]}var B=i[u];for(var C=0,D=B.length/3;C<D;++C){var E=[null,null,null];for(var F=0;F<3;++F){var G=B[3*C+F],H=E[F]=w[G];H[3]=t[y[+(t[y[0]]===4294967295)]]}var I=[E[1][0]-E[0][0],E[1][1]-E[0][1],E[1][2]-E[0][2]],J=[E[2][0]-E[0][0],E[2][1]-E[0][1],E[2][2]-E[0][2]],K=[I[1]*J[2]-I[2]*J[1],I[2]*J[0]-I[0]*J[2],I[0]*J[1]-I[1]*J[0]],L=Math.sqrt(Math.pow(K[0],2)+Math.pow(K[1],2)+Math.pow(K[2],2)),M=[-K[0]/L,-K[1]/L,-K[2]/L];a.push([E,M])}}self.postMessage({command:"update",position:[j,k,l],polygons:a})},VOXEL.RegionMap=function(a){this.blockMap=a||new VOXEL.BlockMap,this.indexedRegions=Object.create(null),this.regionsNeedingUpdate=[]},VOXEL.RegionMap.prototype.prepareRegionUpdate=function(a,b,c){a=Math.floor(a),b=Math.floor(b),c=Math.floor(c);var d=a+"/"+b+"/"+c,e=this.indexedRegions[d];e||(e=this.indexedRegions[d]=new VOXEL.Region(this,a,b,c)),e.needsUpdate||(this.regionsNeedingUpdate.push(e),e.needsUpdate=!0)},VOXEL.RegionMap.prototype.set=function(a,b,c,d){a=Math.floor(a),b=Math.floor(b),c=Math.floor(c);var e=VOXEL.Region.width,f=VOXEL.Region.height,g=VOXEL.Region.depth,h=Math.floor(a/e),i=Math.floor(b/f),j=Math.floor(c/g),k=a%e===0,l=b%f===0,m=c%g===0;this.prepareRegionUpdate(h,i,j),k&&this.prepareRegionUpdate(h-1,i,j),l&&this.prepareRegionUpdate(h,i-1,j),m&&this.prepareRegionUpdate(h,i,j-1),k&&l&&this.prepareRegionUpdate(h-1,i-1,j),k&&m&&this.prepareRegionUpdate(h-1,i,j-1),l&&m&&this.prepareRegionUpdate(h,i-1,j-1),k&&l&&m&&this.prepareRegionUpdate(h-1,i-1,j-1),this.blockMap.set(a,b,c,d)},VOXEL.RegionMap.prototype.get=function(a,b,c){return this.blockMap.get(a,b,c)},VOXEL.RegionMap.prototype.updateAll=function(){var a=this.regionsNeedingUpdate;for(var b=0,c=a.length;b<c;++b){var d=a[b];d.update(),d.needsUpdate=!1}},VOXEL.Application=function(){this.models=Object.create(null)},VOXEL.Application.prototype.onMessage=function(a){var b=a.data;switch(b.command){case"initialization":this.onInitializationCommand(b.configuration);break;case"commit":this.onCommitCommand(b.operations)}},VOXEL.Application.prototype.onInitializationCommand=function(a){VOXEL.Region.width=a.region[0],VOXEL.Region.height=a.region[1],VOXEL.Region.depth=a.region[2],VOXEL.Block.width=a.block[0],VOXEL.Block.height=a.block[1],VOXEL.Block.depth=a.block[2],this.regionMap=new VOXEL.RegionMap},VOXEL.Application.prototype.onCommitCommand=function(a){var b=this.regionMap.set.bind(this.regionMap);for(var c=0,d=a.length;c<d;++c){var e=a[c];switch(e.type){case"set":this.onSetOperation(e.x,e.y,e.z,e.value);break;case"prepare":this.onPrepareOperation(e.id,e.model);break;case"apply":this.onApplyOperation(e.id,e.arguments);break;case"release":this.onReleaseOperation(e.id)}b(e[0],e[1],e[2],e[3])}this.regionMap.blockMap.mergeAll(),this.regionMap.updateAll()},VOXEL.Application.prototype.onSetOperation=function(a,b,c,d){this.regionMap.set(a,b,c,d)},VOXEL.Application.prototype.onPrepareOperation=function(a,b){this.models[a]=b},VOXEL.Application.prototype.onApplyOperation=function(a,b){var c=this.models[a],d=c.type.charAt(0).toUpperCase()+c.type.substr(1).toLowerCase()+"Brush";VOXEL[d].apply(null,[c,this.regionMap].concat(b))},VOXEL.Application.prototype.onReleaseOperation=function(a){this.models[a]=null,delete this.models[a]},function(){var a=new VOXEL.Application;self.onmessage=a.onMessage.bind(a)}()'